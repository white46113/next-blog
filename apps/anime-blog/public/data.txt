import { motion } from "framer-motion";
import { Sparkles, Play, Film } from "lucide-react";

import React, { useState, useEffect } from "react";

// Anime Personality Quiz - Single-file React component for Next.js + Tailwind
// Put this file in `pages/quiz.jsx` (Next.js pages dir) or `app/quiz/page.jsx` if using the app router.
// Tailwind CSS should already be set up in your project.

const QUESTIONS = [
  {
    id: 1,
    q: "What's your ideal weekend plan?",
    options: [
      { id: "a", t: "shonen", text: "Train hard, binge action-packed shows" },
      { id: "b", t: "slice", text: "Relax with cozy slice-of-life anime" },
      { id: "c", t: "isekai", text: "Start a new adventure (game or story)" },
      { id: "d", t: "psy", text: "Watch something mind-bending and deep" },
    ],
  },
  {
    id: 2,
    q: "Pick a favorite color palette:",
    options: [
      { id: "a", t: "slice", text: "Soft pastels" },
      { id: "b", t: "shonen", text: "Bold primary colors" },
      { id: "c", t: "psy", text: "Muted, moody tones" },
      { id: "d", t: "isekai", text: "Vibrant fantasy hues" },
    ],
  },
  {
    id: 3,
    q: "What's the best protagonist trait?",
    options: [
      { id: "a", t: "shonen", text: "Determination and growth" },
      { id: "b", t: "psy", text: "Complex, flawed mind" },
      { id: "c", t: "slice", text: "Relatable and chill" },
      { id: "d", t: "isekai", text: "Quirky outsider vibe" },
    ],
  },
  {
    id: 4,
    q: "Which soundtrack would you pick?",
    options: [
      { id: "a", t: "shonen", text: "Pumped-up battle themes" },
      { id: "b", t: "slice", text: "Mellow acoustic" },
      { id: "c", t: "psy", text: "Haunting ambient" },
      { id: "d", t: "isekai", text: "Epic orchestral" },
    ],
  },
  {
    id: 5,
    q: "You find a mysterious item — it probably: ",
    options: [
      { id: "a", t: "isekai", text: "Teleports you to another world" },
      { id: "b", t: "shonen", text: "Gives a power-up" },
      { id: "c", t: "slice", text: "Reminds you of home" },
      { id: "d", t: "psy", text: "Unravels a secret about you" },
    ],
  },
];

const RESULTS = {
  shonen: {
    title: "The Shonen Spirit",
    desc: "You love hype, growth, and big emotional wins. You enjoy series where characters train, fail, learn, and then come back stronger.",
    recs: ["My Hero Academia", "Naruto", "Demon Slayer"],
  },
  slice: {
    title: "Cozy Slice-of-Life",
    desc: "You appreciate small moments, warm character interactions, and soothing worldbuilding. You’re here for feelings and comfort.",
    recs: ["Barakamon", "March Comes in Like a Lion", "K-On!"],
  },
  isekai: {
    title: "The Adventurer (Isekai)",
    desc: "You dream of other worlds. Escapism, exploration, and quirky fantasy settings make your day.",
    recs: ["Re:Zero", "That Time I Got Reincarnated as a Slime", "Konosuba"],
  },
  psy: {
    title: "Psychological / Mind-bending",
    desc: "You enjoy twists, unreliable narrators, and shows that leave you thinking long after they end.",
    recs: ["Paranoia Agent", "Monster", "Serial Experiments Lain"],
  },
};

// --- QUIZ BUNDLE SUPPORT ADDED ---
// This file now includes multiple quizzes in one bundle.
// Quizzes:
// 1. Personality Quiz (existing)
// 2. Genre Quiz
// 3. "What To Watch Next" Quiz
// A selector screen is added so users can pick which quiz to take.

export default function QuizBundle() {
  const [step, setStep] = useState(0); // 0 = intro, 1..n = questions, n+1 = result
  const [answers, setAnswers] = useState({});
  const [scores, setScores] = useState({ shonen: 0, slice: 0, isekai: 0, psy: 0 });
  const [resultKey, setResultKey] = useState(null);

  useEffect(() => {
    // load progress from localStorage
    try {
      const saved = localStorage.getItem("anime_quiz_progress");
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed.step) setStep(parsed.step);
        if (parsed.answers) setAnswers(parsed.answers);
        if (parsed.scores) setScores(parsed.scores);
      }
    } catch (e) {
      // ignore
    }
  }, []);

  useEffect(() => {
    // persist progress
    const payload = { step, answers, scores };
    try {
      localStorage.setItem("anime_quiz_progress", JSON.stringify(payload));
    } catch (e) {}
  }, [step, answers, scores]);

  function startQuiz() {
    setStep(1);
    setAnswers({});
    setScores({ shonen: 0, slice: 0, isekai: 0, psy: 0 });
    setResultKey(null);
  }

  function selectOption(questionId, option) {
    setAnswers((prev) => ({ ...prev, [questionId]: option.id }));
    // update scores
    setScores((prev) => {
      const next = { ...prev };
      next[option.t] = (next[option.t] || 0) + 1;
      return next;
    });

    // move to next step after a tiny delay for UX
    const nextStep = questionId < QUESTIONS.length ? step + 1 : QUESTIONS.length + 1;
    setTimeout(() => setStep(nextStep), 250);
  }

  function computeResult() {
    const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
    const top = sorted[0][0];
    setResultKey(top);
  }

  useEffect(() => {
    if (step === QUESTIONS.length + 1) {
      computeResult();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [step]);

  function resetQuiz() {
    localStorage.removeItem("anime_quiz_progress");
    startQuiz();
  }

  function shareResult() {
    if (!resultKey) return;
    const text = `I got ${RESULTS[resultKey].title} on the Anime Personality Quiz — try it: ${typeof window !== 'undefined' ? window.location.href : ''}`;
    if (navigator.share) {
      navigator.share({ text }).catch(() => {});
    } else {
      navigator.clipboard?.writeText(text).then(() => alert("Result copied to clipboard!"));
    }
  }

  return (
    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ duration: 0.6 }} className="min-h-screen bg-gradient-to-b from-gray-900 to-gray-800 text-gray-100 p-6 flex items-center justify-center">
      <div className="max-w-4xl w-full bg-gray-900/60 backdrop-blur-md rounded-2xl p-6 shadow-2xl">
        {step === -1 && (
          <div>
            <h1 className="text-3xl font-bold mb-4">Anime Quiz Center</h1>
            <p className="mb-6 text-gray-300">Choose a quiz to get started:</p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => setStep(0)} className="p-4 rounded-xl bg-indigo-600 hover:bg-indigo-500">Personality Quiz</button>
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => setStep(-2)} className="p-4 rounded-xl bg-gray-700 hover:bg-gray-600">Genre Quiz</button>
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => setStep(-3)} className="p-4 rounded-xl bg-gray-700 hover:bg-gray-600">What To Watch Next</button>
            </div>
          </div>
        )}

        {/* Personality Quiz Original UI Follows */
    <div className="min-h-screen bg-gradient-to-b from-gray-900 to-gray-800 text-gray-100 p-6 flex items-center justify-center">
      <div className="max-w-3xl w-full bg-gray-900/60 backdrop-blur-md rounded-2xl p-6 shadow-2xl">
        <h1 className="text-3xl font-bold mb-2">Which Anime Character Type Are You?</h1>
        <p className="mb-6 text-gray-300">A quick, friendly quiz to match you with an anime vibe. No accounts, fully client-side.</p>

        {step === 0 && (
          <div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div className="p-4 bg-gray-800 rounded-lg">
                <h3 className="font-semibold">Why take it?</h3>
                <ul className="list-disc list-inside text-gray-300">
                  <li>Fun, shareable results</li>
                  <li>Lightweight and fast — everything runs in your browser</li>
                  <li>Easy to expand with more questions</li>
                </ul>
              </div>
              <div className="p-4 bg-gray-800 rounded-lg">
                <h3 className="font-semibold">How it works</h3>
                <p className="text-gray-300">Pick the option that fits best. At the end, you'll get a matching "type" with recommended anime.</p>
              </div>
            </div>

            <div className="flex gap-3">
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={startQuiz} className="px-5 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold">Start Quiz</button>
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => { setStep(QUESTIONS.length + 1); }} className="px-5 py-3 rounded-xl bg-gray-700 hover:bg-gray-600">Surprise me (fast)</button>
            </div>
          </div>
        )}

        {step >= 1 && step <= QUESTIONS.length && (
          <div>
            <div className="mb-4 flex items-center justify-between">
              <div className="text-sm text-gray-400">Question {step} of {QUESTIONS.length}</div>
              <div className="text-sm text-gray-400">Progress: {Object.keys(answers).length}/{QUESTIONS.length}</div>
            </div>

            <div className="bg-gray-800 p-6 rounded-xl">
              <h2 className="text-xl font-semibold mb-4">{QUESTIONS[step - 1].q}</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {QUESTIONS[step - 1].options.map((opt) => (
                  <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}
                    key={opt.id}
                    onClick={() => selectOption(QUESTIONS[step - 1].id, opt)}
                    className="text-left p-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition"
                  >
                    {opt.text}
                  </button>
                ))}
              </div>
            </div>

            <div className="mt-4 flex justify-between items-center">
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => { if (step > 1) setStep(step - 1); }} className="px-4 py-2 bg-gray-700 rounded-lg">Back</button>
              <div className="text-gray-400">Tip: Your first instinct is usually best.</div>
              <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={() => { setStep(QUESTIONS.length + 1); }} className="px-4 py-2 bg-gray-700 rounded-lg">Finish early</button>
            </div>
          </div>
        )}

        {step === QUESTIONS.length + 1 && resultKey && (
          <div className="mt-6">
            <div className="bg-gray-800 p-6 rounded-xl">
              <h2 className="text-2xl font-bold mb-2">{RESULTS[resultKey].title}</h2>
              <p className="text-gray-300 mb-4">{RESULTS[resultKey].desc}</p>
              <h3 className="font-semibold">Recommended to watch:</h3>
              <ul className="list-disc list-inside mb-4">
                {RESULTS[resultKey].recs.map((r) => <li key={r}>{r}</li>)}
              </ul>

              <div className="flex gap-3">
                <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={shareResult} className="px-4 py-2 bg-indigo-600 rounded-lg">Share Result</button>
                <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={resetQuiz} className="px-4 py-2 bg-gray-700 rounded-lg">Retake</button>
                <a href="/" className="px-4 py-2 bg-gray-700 rounded-lg">Back to Home</a>
              </div>
            </div>

            <div className="mt-4 p-4 bg-gray-800 rounded-lg">
              <h4 className="font-semibold mb-2">Why this result?</h4>
              <p className="text-gray-300">We tally your answers to find which vibe you chose most. You can expand this logic to weight answers differently or add tie-breakers.</p>
            </div>
          </div>
        )}

        {step === QUESTIONS.length + 1 && !resultKey && (
          <div className="mt-6 p-6 bg-gray-800 rounded-xl">
            <p className="text-gray-300">Calculating result...</p>
          </div>
        )}

        <div className="mt-6 text-sm text-gray-500">All quiz data is stored in the browser only. Customize questions & results in the component (QUESTIONS & RESULTS).</div>
      </div>
    </div>
  );
}
